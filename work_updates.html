<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Work Details</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/d00c9b568a.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.3/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <style>
        /* Styles for modl */
        .modl {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modl-content {
            background-color: #1f2937;
            margin: 20% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 10px;
            color: #fff; /* Text color */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            cursor: pointer;
        }

        /* Styles for form */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #111827; /* Text color */
            background-color: #e5e7eb; /* Background color */
        }

        .input-group button {
            padding: 0.5rem 1rem;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .input-group button:hover {
            background-color: #45a049;
        }
    
        /* Add some padding and background color to the table */
        table {
            padding: 1em;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
    
        
            /* Add some padding and background color to the table */
            table {
                padding: 1em;
                background-color: #1f2937;
                border-radius: 5px;
                color: #fff;
            }

            /* Add some padding, border and background color to the table cells */
            th, td {
                padding: 0.5em;
                border: 1px solid #4B5563;
                background-color: #1f2937;
            }

            /* Add some hover effect to the table rows */
            tr:hover {
                background-color: #2D3748;
            }

            /* Add some style to the table header */
            thead {
                background-color: #4B5563;
                color: #E5E7EB;
            }
            
            

            #summary_section {
                flex-direction: row;
            }

            #summary_stats {
                margin-right: 1rem;
            }
#owner_summary ul {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 20px; /* adjust this value to control the space between owners */
}

#owner_summary ul li {
    list-style-type: none;
    background-color: #4B5563;
    color: #E5E7EB;
    padding: 0.5rem 1rem;
    border-radius: 5px;
}

#owner_summary ul li span {
    font-weight: bold;
}

#owner_summary ul li:not(:last-child) {
    margin-right: 20px;
}

#owner_summary ul li:hover {
    background-color: #2D3748;
}


#work_details_table td.line-through {
    text-decoration: line-through;
}


/* Modal styles */
.gpModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            padding-top: 60px;
        }

        .gpModal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        input[type=text], input[type=date], input[type=number] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            box-sizing: border-box;
            background-color: #333;
            color: white;
            border: 1px solid #555;
        }

        label {
            margin-top: 12px;
        }

        button[type=submit] {
            background-color: #3d98dd;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        button[type=submit]:hover {
            background-color: #357abd;
        }

        input:invalid {
            border-color: red;
        }
        .error {
            color: green;
            display: none;
            margin-top: -10px;
            margin-bottom: 10px;
        }


    #ticker {
        position: relative;
        animation: ticker 10s linear infinite;
    }

        @keyframes ticker {
         0% { left: 100%; }
        100% { left: -100%; }
        }
        </style>
    
    <body class="bg-gray-900 text-white">
    <nav class="flex justify-between items-center p-4 bg-gray-800">
        <h1 class="text-2xl font-bold">Work Details</h1>
        <div>
            <button id="download_button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Download PDF
            </button>
            <button id="logout_button" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded">
                <i class="fas fa-sign-out-alt"></i>
            </button>
            <button id="add_button" class="ml-2 px-4 py-2 bg-green-600 hover:bg-green-700 rounded">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </nav>

    <div id="tickerContainer" style="overflow: hidden; white-space: nowrap;">
        <div id="ticker" style="position: relative; animation: ticker 40s linear infinite;">
            <!-- Add your ticker content here -->
            <span>hi Issadeen</span>
        </div>
    </div>

    <!-- modl -->
    <div id="mymodl" class="modl">
        <div class="modl-content bg-gray-800">
            <span class="close">&times;</span>
            <form id="add_work_form">
                <div class="input-group">
                    <label for="owner">Owner:</label>
                    <input type="text" id="owner" name="owner" required>
                </div>
                <div class="input-group">
                    <label for="product">Product:</label>
                    <input type="text" id="product" name="product" required>
                </div>
                <div class="input-group">
                    <label for="destination">destination:</label>
                    <input type="text" id="destination" name="destination" required>
                </div>
                <div class="input-group">
                    <label for="truck_number">Truck Number:</label>
                    <input type="text" id="truck_number" name="truck_number" required>
                </div>
                <div class="input-group">
                    <label for="quantity">Quantity:</label>
                    <input type="text" id="quantity" name="quantity" required>
                </div>
                <div class="input-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" name="price" required style="width: 100%; height: 30px;">
                </div>
                <div class="input-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" required style="width: 100%; height: 30px;">
                        <option value="queued">Queued</option>
                        <option value="not queued">Not Queued</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="orderno">Order Number:</label>
                    <input type="text" id="orderno" name="orderno" required>
                </div>
                <div class="input-group">
                    <label for="depot">Depot:</label>
                    <input type="text" id="depot" name="depot" required>
                </div>
                <button type="button" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded" onclick="closemodl()">Cancel</button>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>
    <div class="max-w-full mx-auto my-10 p-8 bg-gray-800 rounded">
        <table class="table-auto w-full" id="work_details_table">
            <!-- Table content -->
            <input type="text" id="search" placeholder="Search by owner's name" style="color: white; background-color: #2d3748;">
            <thead>
                <tr>
                    <th class="px-4 py-2">Owner</th>
                    <th class="px-4 py-2">Product</th>
                    <th class="px-4 py-2">Truck Number</th>
                    <th class="px-4 py-2">Quantity</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Order Number</th> <!-- New column -->
                    <th class="px-4 py-2">Depot</th> <!-- New column -->
                    <th class="px-4 py-2">destination</th> <!-- New column -->
                    <th class="px-4 py-2">Actions</th> <!-- New column for delete button -->
                </tr>
            </thead>
            <tbody id="work_details_table_body">
                <!-- Table rows will be added dynamically using JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- The Modal -->
    <div id="gpModal" class="gpModal">
        <div class="gpModal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <form id="gatePassForm">
                <label for="code">Code:</label>
                <input type="text" id="code" name="code" required>

                <label for="date">Date:</label>
                <input type="date" id="date" name="date" required>

                <label for="licensePlate">License Plate:</label>
                <input type="text" id="licensePlate" name="licensePlate" pattern="^[A-Z0-9]+-[A-Z0-9]+$" required>
                <div id="licensePlateError" class="error">Please use the format: ABC1234-XYZ5678</div>

                <label for="destination">Destination:</label>
                <input type="text" id="destination" name="destination" required>

                <label for="fuelType">Fuel Type:</label>
                <input type="text" id="fuelType" name="fuelType" required>

                <label for="totalLiters">Total Liters:</label>
                <input type="number" id="totalLiters" name="totalLiters" required>

                <label for="liters1">Liters 1:</label>
                <input type="number" id="liters1" name="liters1" required>

                <label for="liters2">Liters 2:</label>
                <input type="number" id="liters2" name="liters2" required>

                <label for="liters3">Liters 3:</label>
                <input type="number" id="liters3" name="liters3" required>

                <label for="passNumber">Pass Number:</label>
                <input type="text" id="passNumber" name="passNumber" required>

                <label for="name1">Name 1:</label>
                <input type="text" id="name1" name="name1" required>

                <label for="name2">Name 2:</label>
                <input type="text" id="name2" name="name2" required>

                <label for="loadingPoint">Loading Point:</label>
                <input type="text" id="loadingPoint" name="loadingPoint" required>

                <label for="at20">At 20:</label>
                <input type="text" id="at20" name="at20" required>

                <button type="button" onclick="generatePDF(this)">Generate Gate Pass</button>
            </form>
        </div>
</div>

    
    
        <!-- Summary section -->
        <div id="summary_section" class="mt-4 flex">
            <h2 class="text-lg font-semibold mb-2">Summary</h2>
            <div id="summary_stats" class="flex flex-wrap gap-4"></div>
            <div id="owner_summary"></div>
        </div>
   
    

    
    <script>
            // Initialize Firebase app
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            // Get a reference to the Realtime Database
            const db = firebase.database();

            // Get a reference to the "work_details" node in the database
            const workDetailsRef = db.ref("work_details");

            // Hide the gatePassForm initially
            document.getElementById('gatePassForm').style.display = 'none';

            // Get the modl
            const modl = document.getElementById("mymodl");
            // Get the button that opens the modl
            const btn = document.getElementById("add_button");
            // Get the <span> element that closes the modl
            const span = document.getElementsByClassName("close")[0];

            // Define the openmodl function
            function openmodl() {
                modl.style.display = "block";
            }

            // Define the closemodl function
            function closemodl() {
                modl.style.display = "none";
            }

            // When the user clicks the button, open the modl and stop event propagation
            btn.onclick = function(event) {
                event.stopPropagation();
                openmodl();
            }

            // When the user clicks on <span> (x), close the modl
            span.onclick = function() {
                closemodl();
            }

            // When the user clicks on <span> (x), close the modal
            span.onclick = function(event) {
                event.stopPropagation();
                closemodl();
            }
    </script>
<script>
    // Declare summary variables at a higher scope
    var totalOrders = 0;
    var queuedOrders = 0;
    var unqueuedOrders = 0;
    var agoOrders = 0;
    var pmsOrders = 0;
    var ownerSummary = {};
    
    // Listen for changes to the data in the "work_details" node
    workDetailsRef.on("value", function(snapshot) {
        var workDetails = snapshot.val();
        if (workDetails) {
            var tableBody = document.getElementById("work_details_table_body");
            tableBody.innerHTML = "";
    
            // Reset summary variables
            totalOrders = 0;
            queuedOrders = 0;
            unqueuedOrders = 0;
            agoOrders = 0;
            pmsOrders = 0;
            ownerSummary = {};

            // Loop through the child nodes of the "work_details" node
            snapshot.forEach(function(childSnapshot) {
                var childData = childSnapshot.val();
                // Increment total orders count
                totalOrders++;
    
                // Increment queued or unqueued orders count based on status
                if (childData.status === "queued") {
                    queuedOrders++;
                } else {
                    unqueuedOrders++;
                }
    
                // Increment ago or pms orders count based on product
                if (childData.product.trim().toUpperCase() === "AGO") {
                    agoOrders++;
                } else if (childData.product.trim().toUpperCase() === "PMS") {
                    pmsOrders++;
                }
    
                // Increment owner's orders count and product count
                if (!ownerSummary[childData.owner]) {
                    ownerSummary[childData.owner] = {
                        totalOrders: 1,
                        agoOrders: childData.product.trim().toUpperCase() === "AGO" ? 1 : 0,
                        pmsOrders: childData.product.trim().toUpperCase() === "PMS" ? 1 : 0,
                        queuedOrders: childData.status === "queued" ? 1 : 0,
                        unqueuedOrders: childData.status === "not queued" ? 1 : 0,
                        products: {}
                    };
                } else {
                    ownerSummary[childData.owner].totalOrders++;
                    ownerSummary[childData.owner].agoOrders += childData.product.trim().toUpperCase() === "AGO" ? 1 : 0;
                    ownerSummary[childData.owner].pmsOrders += childData.product.trim().toUpperCase() === "PMS" ? 1 : 0;
                    ownerSummary[childData.owner].queuedOrders += childData.status === "queued" ? 1 : 0;
                    ownerSummary[childData.owner].unqueuedOrders += childData.status === "not queued" ? 1 : 0;
                }
    
                // Increment product count for each owner
                if (!ownerSummary[childData.owner].products[childData.product]) {
                    ownerSummary[childData.owner].products[childData.product] = 1;
                } else {
                    ownerSummary[childData.owner].products[childData.product]++;
                }
    
                // Create table rows for each order (code omitted for brevity)
            });
    
            // Update summary section (code omitted for brevity)
            updateSummarySection();

            // Update ticker
function updateTicker() {
    const ticker = document.getElementById('ticker');
    ticker.innerHTML = `Total Orders: ${totalOrders}, Queued Orders: ${queuedOrders}, Unqueued Orders: ${unqueuedOrders}, AGO Orders: ${agoOrders}, PMS Orders: ${pmsOrders}`;
}

// Call updateTicker function whenever you update the variables
updateTicker();
        }
    });
    
// Initialize loadedTrucks and pendingOrders count
let loadedTrucks = 0;
let pendingOrders = 0;

// Get a reference to your Firebase data
var ref = firebase.database().ref("path/to/your/data");

// Use the `on` method to listen for data changes
ref.on("value", function(snapshot) {
    snapshot.forEach(function(childSnapshot) {
        var childData = childSnapshot.val();

        // Check if the truck is loaded
        if (childData.loaded) {
            loadedTrucks++;
        }

        // Check if the order is queued and the truck is not loaded
        if (childData.status === "queued" && !childData.loaded) {
            pendingOrders++;
        }
    });
}, function (error) {
    console.log("Error: " + error.code);
});
    
    
     // Update the summary section with the latest data
     function updateSummarySection() {
        // Get the summary section and the summary stats div
        const summarySection = document.getElementById("summary_section");
        const summaryStats = document.getElementById("summary_stats");
        const ownerSummaryDiv = document.getElementById("owner_summary");

        // Update the summary stats
        summaryStats.innerHTML = `
            <div class="bg-gray-700 p-4 rounded">
                <div>Total Orders: ${totalOrders}</div>
                <div>Queued Orders: ${queuedOrders}</div>
                <div>Unqueued Orders: ${unqueuedOrders}</div>
                <div>Loaded Trucks: ${loadedTrucks}</div>
                <div>Pending Orders: ${pendingOrders}</div>
                <div>AGO Orders: ${agoOrders}</div>
                <div>PMS Orders: ${pmsOrders}</div>
            </div>
        `;

        // Update the owner summary with flexbox
        ownerSummaryDiv.innerHTML = "";
        ownerSummaryDiv.classList.add("flex", "flex-wrap", "gap-4"); // Apply flexbox to the container

        for (const owner in ownerSummary) {
            const ownerData = ownerSummary[owner];
            ownerSummaryDiv.innerHTML += `
                <div class="bg-gray-700 p-4 rounded mt-4 basis-1/3">
                    <h3 class="text-lg font-semibold">${owner}</h3>
                    <div>Total Orders: ${ownerData.totalOrders}</div>
                    <div>Queued Orders: ${ownerData.queuedOrders}</div>
                    <div>Unqueued Orders: ${ownerData.unqueuedOrders}</div>
                    <div>Loaded Trucks: ${ownerData.loadedTrucks}</div>
                    <div>Pending Orders: ${ownerData.pendingOrders}</div>
                    <div>AGO Orders: ${ownerData.agoOrders}</div>
                    <div>PMS Orders: ${ownerData.pmsOrders}</div>
                    <div class="mt-2">
                        <h4 class="text-md font-semibold">Products</h4>
                        <ul>
                            ${Object.keys(ownerData.products).map(product => `<li>${product}: ${ownerData.products[product]}</li>`).join("")}
                        </ul>
                    </div>
                </div>
            `;
        }
    }
    </script>
    <script>
// Listen for changes to the data in the "work_details" node
workDetailsRef.on("value", function(snapshot) {
            var workDetails = snapshot.val();
            if (workDetails) {
                var tableBody = document.getElementById("work_details_table_body");
                tableBody.innerHTML = "";
                // Loop through the child nodes of the "work_details" node
                snapshot.forEach(function(childSnapshot) {
                    var childData = childSnapshot.val();
                    // Check if all required data is present
                    if (childData.owner && childData.product && childData.truck_number && childData.quantity && childData.orderno && childData.depot && childData.destination) {
                        // Create table rows
                        var row = tableBody.insertRow();
                        row.insertCell().textContent = childData.owner;
                        row.insertCell().textContent = childData.product;
                        // Create cell for truck number
                        var truckNumberCell = row.insertCell();
                        var truckInput = document.createElement("input");
                        truckInput.type = "text";
                        truckInput.value = childData.truck_number;
                        truckInput.classList.add("bg-gray-800", "text-white", "p-2", "rounded", "focus:outline-none", "focus:bg-gray-900");
                        truckInput.disabled = true; // Disable input by default
                        truckNumberCell.appendChild(truckInput);
                        // Display the latest previous truck number
                        if (childData.previous_trucks && childData.previous_trucks.length > 0) {
                            var latestPreviousTruck = childData.previous_trucks[childData.previous_trucks.length - 1];
                            var previousTruckText = document.createElement("small");
                            previousTruckText.textContent = "Previous: " + latestPreviousTruck;
                            truckNumberCell.appendChild(previousTruckText);
                        }
                        row.insertCell().textContent = childData.quantity;
                        // Create cell for status
                        var statusCell = row.insertCell();
                        var statusButton = document.createElement("button");
                        statusButton.classList.add("px-4", "py-2", "rounded");
                        statusButton.textContent = childData.status;
                        statusButton.onclick = function() {
                            childData.status = childData.status === "queued" ? "not queued" : "queued";
                            statusButton.textContent = childData.status;
                            // Save the updated status to Firebase
                            workDetailsRef.child(childSnapshot.key).update({ status: childData.status });
                        };
                        statusCell.appendChild(statusButton);
                        row.insertCell().textContent = childData.orderno; // New field
                        row.insertCell().textContent = childData.depot; // New field
                        row.insertCell().textContent = childData.destination; // New field
                        // Add button for loaded/paid status change
                        var actionsCell = row.insertCell();

                        // Create the actions button (Paid/Loaded)
                        var actionsButton = document.createElement("button");
                        actionsButton.classList.add("bg-green-600", "hover:bg-green-700", "px-4", "py-2", "rounded", "mr-4");
                        // Create Font Awesome icons
                        var paidIcon = document.createElement("i");
                        paidIcon.classList.add("fas", "fa-check");

                        // Add GP button 
                        const gpButton = document.createElement("button");
                        gpButton.textContent = "GP";
                        gpButton.classList.add("bg-blue-600", "hover:bg-blue-700", "px-4", "py-2", "rounded", "mr-4");
                        gpButton.style.display = 'none'; // Hide GP button initially
                        gpButton.onclick = function() {
                            // Populate and show the gate pass form
                            populateForm(this);
                            document.getElementById('gatePassForm').style.display = 'block';
                        };

                        // Create a container for the buttons
                        var buttonContainer = document.createElement("div");
                        buttonContainer.style.display = "flex";

                        // Set initial button content for actionsButton
                        if (childData.loaded && childData.paid) {
                            actionsButton.appendChild(paidIcon);
                            actionsButton.disabled = true; // Disable the button after paid
                            buttonContainer.appendChild(actionsButton);
                            buttonContainer.appendChild(gpButton); // Append GP button after the actionsButton

                            // Show the GP button when paid is true
                            if (childData.paid) {
                                gpButton.style.display = 'inline-block'; // Display GP button inline
                            }
                        } else if (childData.loaded) {
                            actionsButton.textContent = "Paid?";
                            buttonContainer.appendChild(actionsButton);
                            buttonContainer.appendChild(gpButton); // Append GP button after the actionsButton
                        } else {
                            actionsButton.textContent = "Loaded?";
                            buttonContainer.appendChild(actionsButton);
                            buttonContainer.appendChild(gpButton); // Append GP button after the actionsButton
                        }

                        // Append the container to the actionsCell
                        actionsCell.appendChild(buttonContainer);

                        // Add "Change Truck" button
                        var changeTruckButton = document.createElement("button");
                        changeTruckButton.textContent = "Change Truck";
                        changeTruckButton.classList.add("bg-blue-600", "hover:bg-blue-700", "px-4", "py-2", "rounded", "mr-4");
                        changeTruckButton.onclick = function() {
                            // Check if the order is loaded
                            if (childData.loaded) {
                                // If the order is loaded, return immediately without making any changes
                                return;
                            }
                            if (changeTruckButton.textContent === "Change Truck") {
                                truckInput.disabled = false;
                                changeTruckButton.textContent = "Save";
                                var previousTruckText = document.createElement("small");
                                previousTruckText.textContent = "Previous: " + childData.truck_number;
                                truckNumberCell.appendChild(previousTruckText);
                            } else {
                                // Save the new truck number
                                var newTruckNumber = truckInput.value;
                                // Add the old truck number to the array of previous truck numbers
                                if (!childData.previous_trucks) {
                                    childData.previous_trucks = [];
                                }
                                childData.previous_trucks.push(childData.truck_number);
                                childData.truck_number = newTruckNumber;
                                // Disable input after saving
                                truckInput.disabled = true;
                                changeTruckButton.textContent = "Change Truck";
                                // Save the updated truck number and previous truck numbers to Firebase
                                workDetailsRef.child(childSnapshot.key).update({ truck_number: childData.truck_number, previous_trucks: childData.previous_trucks });
                            }
                        };

                        // Hide the Change Truck button if the order is loaded
                        changeTruckButton.style.display = childData.loaded ? "none" : "inline-block";

                        // Create a container for the 'Loaded/Paid' buttons and 'Change Truck' button
                        var actionButtonsContainer = document.createElement("div");
                        actionButtonsContainer.style.display = "flex";
                        actionButtonsContainer.appendChild(buttonContainer);
                        actionButtonsContainer.appendChild(changeTruckButton);

                        actionsCell.appendChild(actionButtonsContainer);
                        // Add delete button to the row
                        var deleteCell = row.insertCell();
                        var deleteButton = document.createElement("button");
                        deleteButton.classList.add("bg-red-600", "hover:bg-red-700", "px-4", "py-2", "rounded");
                        deleteButton.onclick = function() {
                            deleteOrder(childSnapshot.key); // Pass the key of the order to be deleted
                        };
                        // Create Font Awesome delete icon
                        var deleteIcon = document.createElement("i");
                        deleteIcon.classList.add("fas", "fa-trash-alt");
                        deleteButton.appendChild(deleteIcon);
                        deleteCell.appendChild(deleteButton);
                        actionsButton.onclick = function() {
                            if (!childData.loaded) { 
                                childData.loaded = true;
                                childData.crossedOut = true;
                                actionsButton.textContent = "Paid";
                                // Add the line-through class to all cells
                                for (var i = 0; i < row.cells.length; i++) {
                                row.cells[i].classList.add("line-through");
                                }
                                workDetailsRef.child(childSnapshot.key).update({ loaded: childData.loaded, crossedOut: childData.crossedOut }).catch(console.error); 
                            } else if (!childData.paid) { 
                                childData.paid = true;
                                childData.crossedOut = true;
                                actionsButton.textContent = "";
                                actionsButton.appendChild(paidIcon);
                                actionsButton.disabled = true; 
                                workDetailsRef.child(childSnapshot.key).update({ loaded: childData.loaded, paid: childData.paid, crossedOut: childData.crossedOut }).catch(console.error);
                            } 
                        };
                    } else {
                        console.error("Invalid data format: ", childData);
                    }
                });
            
            
                
        
// After all table rows have been created, add the event listener for the download button
document.getElementById("download_button").addEventListener("click", function () {
    let docDefinition = {
        content: [
            { text: 'Work Details Report', style: 'header' }, // Main heading
            {
                table: {
                    widths: [30, 90, 90, 90, 90, 90, 90, 90, 90], 
                    body: [
                        ['Index', 'Owner', 'Product', 'Truck Number', 'Quantity', 'Status', 'Order Number', 'Depot', 'destination'],
                    ],
                },
                layout: {
                    fillColor: function (rowIndex, node, columnIndex) {
                        return (rowIndex % 2 === 0 && rowIndex !== 0) ? '#f2f2f2' : null;
                    }
                }
            },
        ],
        styles: {
            header: {
                fontSize: 22,
                bold: true,
                alignment: 'center',
                margin: [0, 0, 0, 20]
            },
            subheader: {
                fontSize: 16,
                bold: true,
                margin: [0, 20, 0, 10]
            },
            ownerName: {
                fontSize: 14,
                bold: true,
                margin: [0, 10, 0, 5]
            },
            tableHeader: {
                bold: true,
                fontSize: 12,
                fillColor: '#1f2937',
                color: '#fff' 
            },
            footer: {
                fontSize: 10,
                color: 'grey',
                alignment: 'right',
                margin: [0, 10, 20, 0]
            }
        },
        footer: function (currentPage, pageCount) {
            return { text: 'Page ' + currentPage.toString() + ' of ' + pageCount, style: 'footer' };
        },
        pageOrientation: 'landscape',
    };

    let tableRows = Array.from(document.querySelectorAll("table tr"));
    let rowDataArray = [];

    tableRows.forEach(function(row) {
        let cells = Array.from(row.querySelectorAll("td")).slice(0, 8);
        let rowData = [];
        cells.forEach(function(cell) {
            if (cell !== undefined) {
                let inputElement = cell.querySelector("input");
                if (inputElement) {
                    rowData.push({ text: inputElement.value.trim() });
                } else {
                    rowData.push({ text: cell.textContent.trim() });
                }
            } else {
                console.warn("Undefined cell found in row:", row);
                return;
            }
        });
        if (rowData.length === 8) { // Only add rows with the correct number of cells
            rowDataArray.push(rowData);
        } else {
            console.warn("Row with mismatched number of cells:", row);
        }
    });

    // Sort, handling the header row separately
    rowDataArray.sort((a, b) => {
        if (a[0].text === 'Index') return -1; // Always place header first
        if (b[0].text === 'Index') return 1; // Always place header first
        return a[1].text.localeCompare(b[1].text); // Sort data rows by 'Owner'
    });

    // Add data to table (once)
    rowDataArray.forEach((rowData, index) => {
        rowData.unshift({ text: (index + 1).toString() }); // Add index
        docDefinition.content[1].table.body.push(rowData); // Add to the correct table
    });

    // Add Total Summary (no changes here)
    docDefinition.content.push({ text: 'Total Summary', style: 'subheader' });
    docDefinition.content.push({
        ul: [
            { text: 'Total Orders: ' + totalOrders },
            { text: 'Queued Orders: ' + queuedOrders },
            { text: 'Unqueued Orders: ' + unqueuedOrders },
            { text: 'Loaded Trucks: ' + loadedTrucks },
            { text: 'Pending Orders: ' + pendingOrders },
            { text: 'AGO Orders: ' + agoOrders },
            { text: 'PMS Orders: ' + pmsOrders }
        ],
        margin: [0, 0, 0, 20]
    });


    pdfMake.createPdf(docDefinition).download('work_details_report.pdf'); 
});

 }
});


// Handle form submission
document.getElementById("add_work_form").addEventListener("submit", function(event) {
    event.preventDefault();
    const formData = new FormData(this);
    const newWorkDetail = {};
    formData.forEach(function(value, key) {
        newWorkDetail[key] = value;
    });

    // Add "previous_trucks" field if it doesn't exist
    if (!newWorkDetail.previous_trucks) {
        newWorkDetail.previous_trucks = [];
    }

    // Check if "destination" field exists, if not, set it to an empty string
    if (!newWorkDetail.destination) {
        newWorkDetail.destination = "";
    }

    // Generate unique ID for owner
    const ownerId = generateUniqueId(); // You need to implement this function

    // Save owner's data under the generated ID
    db.ref("owners/" + ownerId).set({
        product: newWorkDetail.product,
        depot: newWorkDetail.depot,
        destination: newWorkDetail.destination
    }).catch(error => {
        console.error("Error saving data to Firebase:", error); // Log any errors
    });

    // Save the new work detail to Firebase
    workDetailsRef.push({
    ...newWorkDetail,  // Spread the existing newWorkDetail properties
    paid: false,        // Add paid property
    crossedOut: false // Add crossedOut property
});

    // Close the modl
    closemodl();
});

// Function to generate unique ID
function generateUniqueId() {
    // Generate a random ID or use a library like UUID for unique ID generation
    // Example:
    return Math.random().toString(36).substr(2, 9);
}

// Function to delete an order
function deleteOrder(orderKey) {
    if (confirm("Are you sure you want to delete this order?")) {
        workDetailsRef.child(orderKey).remove()
            .then(function() {
                console.log("Order deleted successfully");
            })
            .catch(function(error) {
                console.error("Error deleting order: ", error);
            });
    }
}

        // Logout user after 5 minutes of inactivity
        let logoutTimer = null;
        function resetLogoutTimer() {
            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }
            logoutTimer = setTimeout(function() {
                // TODO: Logout user
                alert("You have been logged out due to inactivity.");
                // You should replace the alert with actual logout code
                // For example, if you're using Firebase:
                // firebase.auth().signOut();
            }, 5 * 60 * 1000); // 5 minutes
        }
        resetLogoutTimer();
        document.addEventListener("mousemove", resetLogoutTimer);
        document.addEventListener("keypress", resetLogoutTimer);
        
        // Handle "Logout" button click
        document.getElementById("logout_button").addEventListener("click", function() {
            firebase.auth().signOut().then(function() {
                // No need to reset the logout timer here because the user is being logged out
                window.location.href = "index.html";
            }).catch(function(error) {
                alert("An error occurred while logging out.");
            });
        });
    </script>


    
    <script>
    document.getElementById('search').addEventListener('keyup', function() {
    var search = this.value.toLowerCase();
    var rows = document.querySelectorAll('#work_details_table_body tr');

    for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].querySelectorAll('td');
        var found = false;

        for (var j = 0; j < cells.length; j++) {
            // Get cell content, checking for input elements
            var cellContent = cells[j].textContent.toLowerCase();
            var inputElement = cells[j].querySelector("input");
            if (inputElement) {
                cellContent = inputElement.value.toLowerCase(); 
            }
            
            if (cellContent.indexOf(search) > -1) {
                found = true;
                break;
            }
        }
        rows[i].style.display = found ? "" : "none";
    }
});


    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

<!-- jsPDF and html2canvas CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
async function populateForm(button) {
    // Get the table row containing the clicked button
    const row = button.closest('tr');
    const cells = row.getElementsByTagName('td');

    // Map table cell values to form fields
    document.getElementById('code').value = cells[5].innerText; // Order Number
    document.getElementById('licensePlate').value = cells[2].querySelector('input').value; // Get value from input field
    document.getElementById('destination').value = cells[7].innerText; // Destination
    document.getElementById('fuelType').value = cells[1].innerText; // Product
    document.getElementById('totalLiters').value = cells[3].innerText; // Quantity

    // Set default values for date, loading point, at20, pass number, name1, and name2
    document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Current date
    document.getElementById('loadingPoint').value = cells[6].innerText; // Depot
    document.getElementById('at20').value = 'Default At 20'; // Set as per your logic

    // Set the pass number in the form field
    let lastPassNumber = await getLastPassNumber();
    document.getElementById('passNumber').value = `MOK-GP-${lastPassNumber + 1}`;

    document.getElementById('name1').value = 'ZAINAB AHMED'; // Name 1
    document.getElementById('name2').value = 'IBRAHIM MOHAMED ATHMAN'; // Name 2

    // Display the modal
    document.getElementById('gpModal').style.display = "block";
}

function closeModal() {
    document.getElementById('gpModal').style.display = "none";
}

// Close the modal if the user clicks anywhere outside of the modal
window.onclick = function(event) {
    const modal = document.getElementById('gpModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

async function getLastPassNumber() {
    const snapshot = await db.ref("gatePasses/lastPassNumber").once('value');
    return snapshot.val() || 192; // Default to 192 if not found
}

async function incrementPassNumber() {
    const lastNumber = await getLastPassNumber();
    const newNumber = lastNumber + 1;
    await db.ref("gatePasses/lastPassNumber").set(newNumber);
    return newNumber;
}

async function generatePDF(button) {
    const { jsPDF } = window.jspdf;
    const form = document.getElementById('gatePassForm');

    // Validate license plate format
    const licensePlateInput = document.getElementById('licensePlate');
            const licensePlateError = document.getElementById('licensePlateError');
            const licensePlateValue = licensePlateInput.value;

            if (licensePlateValue.includes('/')) {
                licensePlateError.style.display = 'block';
                licensePlateError.textContent = 'License Plate must use - instead of /.';
                licensePlateInput.focus();
                return;
            } else if (!licensePlateValue.match(/^[A-Z0-9]+-[A-Z0-9]+$/)) {
                licensePlateError.style.display = 'block';
                licensePlateError.textContent = 'License Plate must be in the format ABC123-DEF456.';
                licensePlateInput.focus();
                return;
            } else {
                licensePlateError.style.display = 'none';
            }

   // Check if the form is valid
   if (!form.checkValidity()) {
   form.reportValidity(); // This will highlight the invalid fields
   return;
    }

    // Get form data
    const formData = new FormData(form);
    const truckNumber = formData.get('licensePlate');

    // Check if truck number was used in the last 2 hours
    const twoHoursAgo = Date.now() - 2 * 60 * 60 * 1000;
    const ref = firebase.database().ref('gatePasses');
    const snapshot = await ref.orderByChild('truckNumber').equalTo(truckNumber).limitToLast(1).once('value');
    const lastGatePass = snapshot.val();
    let isDuplicate = false;
    let passNumber;
    if (lastGatePass) {
        const lastPassData = Object.values(lastGatePass)[0];
        if (lastPassData.timestamp > twoHoursAgo) {
            isDuplicate = true;
            passNumber = lastPassData.passNumber;
        } else {
            passNumber = await incrementPassNumber();
        }
    } else {
        passNumber = await incrementPassNumber();
    }

    // Define file names
    const fileName = `gate-pass-${Date.now()}.pdf`;
    const duplicateFileName = `gate-pass-${Date.now()}-duplicate.pdf`;

    // Create a new PDF document
    const doc = new jsPDF('landscape', 'pt', 'a4');

    // Add background image
    const backgroundImg = new Image();
    backgroundImg.src = './public/image.png';

    backgroundImg.onload = function() {
        doc.addImage(backgroundImg, 'PNG', 0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight());

        // Set font to bold 
        doc.setFont('helvetica', 'bold');

        // Add text on top of the background image
        doc.setFontSize(14);
        doc.setTextColor('#3D98DD');

        doc.text(formData.get('code'), 125, 175);
        doc.text(formData.get('date'), 425, 205);
        doc.text(formData.get('licensePlate'), 440, 265);
        doc.text(formData.get('destination'), 100, 250);
        doc.text(formData.get('fuelType'), 120, 340);
        doc.text(formData.get('totalLiters'), 400, 340);
        doc.text(formData.get('liters1'), 700, 340);
        doc.text(formData.get('liters2'), 700, 370);
        doc.text(formData.get('liters3'), 700, 400);
        doc.text(`MOK-GP-${passNumber}`, 700, 175);
        doc.text(formData.get('name1'), 100, 535);
        doc.text(formData.get('name2'), 660, 525);
        doc.text(formData.get('loadingPoint'), 740, 265);
        doc.text(formData.get('at20'), 500, 340);

        if (isDuplicate) {
            doc.text('DUPLICATE', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, { align: 'center' });
        }

        if (isDuplicate) {
            doc.save(duplicateFileName);
        } else {
            doc.save(fileName);
        }

        const gpButton = button;
        const passNumberLink = document.createElement('a');
        passNumberLink.href = `./${isDuplicate ? duplicateFileName : fileName}`;
        passNumberLink.download = isDuplicate ? duplicateFileName : fileName;
        passNumberLink.textContent = `MOK-GP-${passNumber}`;
        passNumberLink.onclick = function(e) {
            e.preventDefault();
            const link = document.createElement('a');
            link.href = `./${isDuplicate ? duplicateFileName : fileName}`;
            link.download = isDuplicate ? duplicateFileName : fileName;
            link.click();
        };
        gpButton.parentNode.replaceChild(passNumberLink, gpButton);
    };

    // Save gate pass data to Firebase only if it's not a duplicate
    if (!isDuplicate) {
        const gatePassData = Object.fromEntries(formData.entries());
        gatePassData.timestamp = Date.now();
        gatePassData.truckNumber = truckNumber;
        gatePassData.passNumber = passNumber; // Save the passNumber to Firebase
        firebase.database().ref(`gatePasses/${truckNumber}`).set(gatePassData);
    }

    // Rename the gpButton to the passNumber
    button.textContent = passNumber;

    // Close the modal after PDF generation
    closeModal();
}

</script>
</body>
</html>
